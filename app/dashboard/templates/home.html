<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard — Cattle Scraper</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f0f23; color: #e0e0e0; line-height: 1.6; }
        nav { background: #1a1a2e; border-bottom: 1px solid #333; padding: 0 2rem; display: flex; align-items: center; }
        nav .brand { font-weight: 700; font-size: 1.1rem; color: #e94560; padding: 1rem 1.5rem 1rem 0; border-right: 1px solid #333; margin-right: .5rem; text-decoration: none; }
        nav a { color: #aaa; text-decoration: none; padding: 1rem; font-size: .9rem; }
        nav a:hover { color: #e94560; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        h1 { font-size: 1.6rem; margin-bottom: 1.5rem; color: #fff; }
        h2 { font-size: 1.2rem; margin: 2rem 0 1rem; color: #ccc; }
        .live-dot { display: inline-block; width: 8px; height: 8px; background: #4ecca3; border-radius: 50%; margin-right: 8px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .card {
            background: #16213e; border-radius: 10px; padding: 1.5rem;
            border: 1px solid #1f3460; transition: border-color 0.3s, transform 0.2s;
            cursor: pointer; text-decoration: none; display: block;
        }
        .card:hover { border-color: #5dade2; transform: translateY(-2px); }
        .card.updated { border-color: #4ecca3; }
        .card .label { font-size: .8rem; color: #888; text-transform: uppercase; letter-spacing: .5px; }
        .card .value { font-size: 2rem; font-weight: 700; color: #e94560; margin-top: .3rem; transition: color 0.3s; }
        .card .value.green { color: #4ecca3; }
        .card .value.blue { color: #5dade2; }
        .card .value.orange { color: #f39c12; }
        .card .hint { font-size: .7rem; color: #555; margin-top: .4rem; }

        /* Performance Timer Section */
        .perf-section {
            background: #16213e; border-radius: 10px; padding: 1.5rem;
            border: 1px solid #1f3460; margin-bottom: 2rem;
        }
        .perf-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 1rem;
        }
        .perf-header h2 { margin: 0; font-size: 1.1rem; color: #ccc; }
        .perf-clock {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 1.8rem; font-weight: 700; color: #5dade2;
            letter-spacing: 2px;
        }
        .perf-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: .8rem;
        }
        .perf-metric {
            background: #111b30; border-radius: 8px; padding: 1rem;
            text-align: center; border: 1px solid #1a2a50;
        }
        .perf-metric .pm-label { font-size: .7rem; color: #666; text-transform: uppercase; letter-spacing: .5px; }
        .perf-metric .pm-value { font-size: 1.4rem; font-weight: 700; color: #4ecca3; margin: .2rem 0; }
        .perf-metric .pm-value.rate { color: #f39c12; }
        .perf-metric .pm-value.blue { color: #5dade2; }
        .perf-metric .pm-unit { font-size: .7rem; color: #555; }
        .perf-bar-wrap {
            margin-top: 1rem; background: #111b30; border-radius: 6px;
            padding: .8rem 1rem; border: 1px solid #1a2a50;
        }
        .perf-bar-label {
            display: flex; justify-content: space-between; font-size: .75rem; color: #888; margin-bottom: .4rem;
        }
        .perf-bar-track {
            height: 6px; background: #0a1020; border-radius: 3px; overflow: hidden;
        }
        .perf-bar-fill {
            height: 100%; background: linear-gradient(90deg, #4ecca3, #5dade2);
            border-radius: 3px; transition: width 1s ease;
        }

        table { width: 100%; border-collapse: collapse; background: #16213e; border-radius: 10px; overflow: hidden; }
        th { background: #1a1a2e; color: #888; font-size: .8rem; text-transform: uppercase; letter-spacing: .5px; padding: .8rem 1rem; text-align: left; }
        td { padding: .7rem 1rem; border-top: 1px solid #1f3460; font-size: .9rem; }
        tr:hover { background: #1f3460; }

        /* Country row styles */
        .country-row { background: #16213e; cursor: pointer; }
        .country-row:hover { background: #1a2a50; }
        .country-row td { font-size: 1rem; padding: .9rem 1rem; }
        .expand-icon {
            display: inline-block;
            width: 1rem;
            text-align: center;
            font-size: .75rem;
            color: #5dade2;
            transition: transform 0.2s ease;
            margin-right: .3rem;
        }
        .expand-icon.expanded { transform: rotate(90deg); }

        /* State row styles */
        .state-row td { color: #aaa; font-size: .85rem; background: #111b30; }
        .state-row:hover td { background: #162040; }
        .state-row td:first-child { color: #ccc; }

        /* View link in table */
        .view-link {
            color: #5dade2; font-size: .8rem; text-decoration: none;
            opacity: 0; transition: opacity 0.2s;
        }
        tr:hover .view-link { opacity: 1; }
        .view-link:hover { text-decoration: underline; }

        /* Update flash */
        .flash { animation: flashGreen 1s ease; }
        @keyframes flashGreen { 0% { color: #4ecca3; } 100% { } }
    </style>
</head>
<body>
    <nav>
        <a href="/" class="brand">Cattle Scraper</a>
        <a href="/">Dashboard</a>
        <a href="/recent">Recent</a>
        <a href="/export">Export</a>
        <a href="/jobs">Jobs</a>
        <a href="/stats">Stats</a>
    </nav>
    <div class="container">
        <h1><span class="live-dot"></span>Dashboard <small style="font-size:.7rem;color:#666;" id="last-update"></small></h1>

        <div class="cards">
            <a class="card" href="/recent">
                <div class="label">Total Emails</div>
                <div class="value" id="stat-total-emails">{{total_emails}}</div>
                <div class="hint">Click to view recent contacts</div>
            </a>
            <a class="card" href="/recent">
                <div class="label">Emails Today</div>
                <div class="value green" id="stat-emails-today">{{emails_today}}</div>
                <div class="hint">Click to view recent contacts</div>
            </a>
            <a class="card" href="/stats">
                <div class="label">This Week</div>
                <div class="value blue" id="stat-emails-week">{{emails_this_week}}</div>
                <div class="hint">Click to view statistics</div>
            </a>
            <a class="card" href="/jobs">
                <div class="label">Active Jobs</div>
                <div class="value orange" id="stat-active-jobs">{{active_jobs}}</div>
                <div class="hint">Click to manage jobs</div>
            </a>
        </div>

        <div class="cards">
            <a class="card" href="/stats">
                <div class="label">Total URLs</div>
                <div class="value blue" id="stat-total-urls">{{total_urls}}</div>
                <div class="hint">Click to view statistics</div>
            </a>
            <a class="card" href="/jobs">
                <div class="label">URLs Pending</div>
                <div class="value orange" id="stat-urls-pending">{{urls_pending}}</div>
                <div class="hint">Click to view jobs</div>
            </a>
            <a class="card" href="/stats">
                <div class="label">URLs Completed</div>
                <div class="value green" id="stat-urls-completed">{{urls_completed}}</div>
                <div class="hint">Click to view statistics</div>
            </a>
            <a class="card" href="/stats">
                <div class="label">URLs Failed</div>
                <div class="value" id="stat-urls-failed">{{urls_failed}}</div>
                <div class="hint">Click to view statistics</div>
            </a>
        </div>

        <!-- Performance Timer -->
        <div class="perf-section">
            <div class="perf-header">
                <h2>Performance Monitor</h2>
                <div class="perf-clock" id="perf-uptime">00:00:00</div>
            </div>
            <div class="perf-grid">
                <div class="perf-metric">
                    <div class="pm-label">Last 1 Minute</div>
                    <div class="pm-value" id="perf-1min">—</div>
                    <div class="pm-unit">emails</div>
                </div>
                <div class="perf-metric">
                    <div class="pm-label">Last 5 Minutes</div>
                    <div class="pm-value" id="perf-5min">—</div>
                    <div class="pm-unit">emails</div>
                </div>
                <div class="perf-metric">
                    <div class="pm-label">Last 15 Minutes</div>
                    <div class="pm-value" id="perf-15min">—</div>
                    <div class="pm-unit">emails</div>
                </div>
                <div class="perf-metric">
                    <div class="pm-label">Last Hour</div>
                    <div class="pm-value blue" id="perf-1hr">—</div>
                    <div class="pm-unit">emails</div>
                </div>
                <div class="perf-metric">
                    <div class="pm-label">Rate / Minute</div>
                    <div class="pm-value rate" id="perf-rate-min">—</div>
                    <div class="pm-unit">avg over 5 min</div>
                </div>
                <div class="perf-metric">
                    <div class="pm-label">Rate / Hour</div>
                    <div class="pm-value rate" id="perf-rate-hr">—</div>
                    <div class="pm-unit">last hour total</div>
                </div>
            </div>
            <div class="perf-bar-wrap">
                <div class="perf-bar-label">
                    <span>24h Collection Progress</span>
                    <span id="perf-24hr-count">0 emails in last 24 hours</span>
                </div>
                <div class="perf-bar-track">
                    <div class="perf-bar-fill" id="perf-24hr-bar" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <h2>Emails by Country</h2>
        <table id="country-table">
            <thead>
                <tr><th>Country / Region</th><th>Email Count</th><th style="width:60px;"></th></tr>
            </thead>
            <tbody id="country-body">
                {{country_sections}}
            </tbody>
        </table>
    </div>

    <script>
        // Track which countries are expanded
        const expandedCountries = new Set();

        function toggleStates(countryCode, event) {
            // Don't toggle if clicking a link
            if (event && event.target.closest('a')) return;

            const rows = document.querySelectorAll('.state-row-' + countryCode);
            const icon = document.getElementById('icon-' + countryCode);
            const isHidden = rows.length > 0 && rows[0].style.display === 'none';

            rows.forEach(row => {
                row.style.display = isHidden ? 'table-row' : 'none';
            });

            if (icon) {
                icon.classList.toggle('expanded', isHidden);
            }

            if (isHidden) {
                expandedCountries.add(countryCode);
            } else {
                expandedCountries.delete(countryCode);
            }
        }

        // Navigate to filtered recent page for a state
        function viewState(countryCode, stateName, event) {
            event.stopPropagation();
            const params = new URLSearchParams();
            params.set('country', countryCode);
            params.set('state', stateName);
            window.location.href = '/recent?' + params.toString();
        }

        // Navigate to filtered recent page for a country
        function viewCountry(countryCode, event) {
            event.preventDefault();
            event.stopPropagation();
            window.location.href = '/recent?country=' + countryCode;
        }

        // Animate number counting up/down
        function animateValue(el, newVal) {
            const current = parseInt(el.textContent.replace(/,/g, '')) || 0;
            if (current === newVal) return;

            const diff = newVal - current;
            const steps = 30;
            const stepTime = 500 / steps;
            let step = 0;

            // Flash the card border
            const card = el.closest('.card');
            if (card && diff !== 0) {
                card.classList.add('updated');
                setTimeout(() => card.classList.remove('updated'), 1500);
            }

            const timer = setInterval(() => {
                step++;
                const progress = step / steps;
                const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic
                const value = Math.round(current + diff * eased);
                el.textContent = value.toLocaleString();
                if (step >= steps) {
                    clearInterval(timer);
                    el.textContent = newVal.toLocaleString();
                }
            }, stepTime);
        }

        // Fetch stats via AJAX and update in-place
        async function refreshStats() {
            try {
                const [statsRes, countryRes] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/api/emails-by-country')
                ]);

                if (!statsRes.ok || !countryRes.ok) return;

                const stats = await statsRes.json();
                const countries = await countryRes.json();

                // Update stat cards with animation
                animateValue(document.getElementById('stat-total-emails'), stats.total_emails || 0);
                animateValue(document.getElementById('stat-emails-today'), stats.emails_today || 0);
                animateValue(document.getElementById('stat-emails-week'), stats.emails_this_week || 0);
                animateValue(document.getElementById('stat-active-jobs'), stats.active_jobs || 0);
                animateValue(document.getElementById('stat-total-urls'), stats.total_urls || 0);
                animateValue(document.getElementById('stat-urls-pending'), stats.urls_pending || 0);
                animateValue(document.getElementById('stat-urls-completed'), stats.urls_completed || 0);
                animateValue(document.getElementById('stat-urls-failed'), stats.urls_failed || 0);

                // Update country table (preserving expand state)
                updateCountryTable(countries);

                // Update timestamp
                const now = new Date();
                document.getElementById('last-update').textContent =
                    'Updated ' + now.toLocaleTimeString();

            } catch (e) {
                console.error('Failed to refresh stats:', e);
            }
        }

        const FLAGS = { US: '\u{1F1FA}\u{1F1F8}', NZ: '\u{1F1F3}\u{1F1FF}', UK: '\u{1F1EC}\u{1F1E7}', CA: '\u{1F1E8}\u{1F1E6}', AU: '\u{1F1E6}\u{1F1FA}' };

        function updateCountryTable(countries) {
            const tbody = document.getElementById('country-body');
            let html = '';

            for (const [code, info] of Object.entries(countries)) {
                const flag = FLAGS[code] || '\u{1F30D}';
                const hasStates = info.states && info.states.length > 0;
                const isExpanded = expandedCountries.has(code);
                const expandIcon = hasStates ? '\u25B6' : '';
                const expandedClass = isExpanded ? ' expanded' : '';
                const clickAttr = hasStates ? ` onclick="toggleStates('${code}', event)" style="cursor:pointer;"` : '';

                html += `<tr class="country-row"${clickAttr}>`;
                html += `<td><span class="expand-icon${expandedClass}" id="icon-${code}">${expandIcon}</span> `;
                html += `${flag} <strong>${info.name}</strong> (${code})</td>`;
                html += `<td><strong>${info.total.toLocaleString()}</strong></td>`;
                html += `<td><a class="view-link" href="/recent?country=${code}" onclick="viewCountry('${code}', event)">View &rarr;</a></td>`;
                html += `</tr>`;

                if (info.states) {
                    for (const s of info.states) {
                        const display = isExpanded ? 'table-row' : 'none';
                        const encodedState = encodeURIComponent(s.state);
                        html += `<tr class="state-row state-row-${code}" style="display:${display};">`;
                        html += `<td style="padding-left:2.5rem;">${s.state}</td>`;
                        html += `<td>${s.count.toLocaleString()}</td>`;
                        html += `<td><a class="view-link" href="/recent?country=${code}&state=${encodedState}" onclick="viewState('${code}', '${s.state.replace(/'/g, "\\'")}', event)">View &rarr;</a></td>`;
                        html += `</tr>`;
                    }
                }
            }

            if (!html) {
                html = '<tr><td colspan="3">No data yet</td></tr>';
            }

            tbody.innerHTML = html;
        }

        // ── Performance Timer ──────────────────────────────────
        let scraperStartTime = null;

        function formatUptime(seconds) {
            const d = Math.floor(seconds / 86400);
            const h = Math.floor((seconds % 86400) / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            const pad = n => String(n).padStart(2, '0');
            if (d > 0) return `${d}d ${pad(h)}:${pad(m)}:${pad(s)}`;
            return `${pad(h)}:${pad(m)}:${pad(s)}`;
        }

        function tickUptime() {
            if (!scraperStartTime) return;
            const now = new Date();
            const elapsed = (now - scraperStartTime) / 1000;
            document.getElementById('perf-uptime').textContent = formatUptime(elapsed);
        }

        async function refreshPerformance() {
            try {
                const res = await fetch('/api/performance');
                if (!res.ok) return;
                const data = await res.json();

                // Update metric values
                document.getElementById('perf-1min').textContent = (data.last_1min || 0).toLocaleString();
                document.getElementById('perf-5min').textContent = (data.last_5min || 0).toLocaleString();
                document.getElementById('perf-15min').textContent = (data.last_15min || 0).toLocaleString();
                document.getElementById('perf-1hr').textContent = (data.last_1hr || 0).toLocaleString();
                document.getElementById('perf-rate-min').textContent = (data.per_minute || 0).toFixed(1);
                document.getElementById('perf-rate-hr').textContent = (data.per_hour || 0).toLocaleString();

                // 24h bar
                const count24 = data.last_24hr || 0;
                document.getElementById('perf-24hr-count').textContent = count24.toLocaleString() + ' emails in last 24 hours';
                // Scale bar: 100% = 1000 emails/day target (adjust as needed)
                const barPct = Math.min(100, (count24 / 1000) * 100);
                document.getElementById('perf-24hr-bar').style.width = barPct + '%';

                // Set scraper start time (use running job start or first contact)
                if (!scraperStartTime) {
                    const startStr = data.scraper_start || data.first_contact;
                    if (startStr) {
                        scraperStartTime = new Date(startStr);
                    }
                }
            } catch (e) {
                console.error('Failed to refresh performance:', e);
            }
        }

        // Initial load + periodic refresh
        refreshPerformance();
        setInterval(refreshPerformance, 10000);
        setInterval(tickUptime, 1000);

        // Poll every 5 seconds for real-time updates
        setInterval(refreshStats, 5000);
    </script>
</body>
</html>
